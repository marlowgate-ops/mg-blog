---
import type { MarkdownHeading } from 'astro';
import CTA from '../components/CTA.astro';
const { frontmatter, headings = [] as MarkdownHeading[] } = Astro.props as any;

const origin = Astro.site?.origin ?? 'https://blog.marlowgate.com';
const path = Astro.url.pathname;
const slug = path.replace(/^\/blog\//, '').replace(/\/$/, '');
const og = `${origin}/og/${slug}.png`;

const title = frontmatter.title ?? 'Untitled';
const description = frontmatter.description ?? '';
const pubISO = (frontmatter.pubDate && new Date(frontmatter.pubDate).toISOString()) || undefined;
const modISO = (frontmatter.updatedDate && new Date(frontmatter.updatedDate).toISOString()) || undefined;
const canonical = `${origin}${path}`;
const tags = Array.isArray(frontmatter.tags) ? frontmatter.tags : [];
const isDraft = frontmatter.draft === true;
---
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} — Marlow Gate</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    {isDraft && <meta name="robots" content="noindex, nofollow" />}
    <!-- Open Graph -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={og} />
    <meta property="og:image:alt" content={title} />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={og} />
    <!-- Article dates -->
    {pubISO && <meta property="article:published_time" content={pubISO} />}
    {modISO && <meta property="article:modified_time" content={modISO} />}

    <style>
      :root{
        --fg:#111; --muted:#666; --line:#eee; --bg:#fff; --bg-soft:#fafafa;
        --max: 980px;
      }
      html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Segoe UI Emoji", "Apple Color Emoji", "Segoe UI Symbol";line-height:1.7}
      a{color:inherit}
      /* Nav */
      nav{border-bottom:1px solid var(--line);background:#fff}
      nav .inner{max-width:var(--max);margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:14px}
      nav .left, nav .right{display:flex;align-items:center;gap:14px}
      nav a{text-decoration:none}
      nav .brand{font-weight:700}

      /* Layout */
      .wrap{max-width:var(--max);margin:0 auto;padding:28px 20px;display:grid;grid-template-columns:1fr;gap:28px}
      @media(min-width:1024px){ .wrap{grid-template-columns:240px 1fr} }
      .toc{position:sticky; top:24px; align-self:start; border:1px solid var(--line); border-radius:12px; padding:14px; background:var(--bg-soft)}
      .toc h2{font-size:14px;margin:0 0 8px 0;color:#333}
      .toc ul{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px}
      .toc a{color:#333;text-decoration:none}
      .toc .lvl2{padding-left:12px}
      .toc .lvl3{padding-left:24px}

      article header{margin:8px 0 16px 0}
      .title{font-size:32px;line-height:1.25;margin:0 0 8px 0;font-weight:800}
      .meta{color:var(--muted);font-size:14px;display:flex;gap:10px;flex-wrap:wrap}
      .tags{display:flex;gap:8px;flex-wrap:wrap}
      .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#333;background:#fff;font-size:12px}
      .tag a{text-decoration:none;color:#333}

      /* Article content */
      .prose{font-size:18px}
      .prose h2{font-size:24px;margin:32px 0 8px 0}
      .prose h3{font-size:20px;margin:24px 0 6px 0}
      .prose p{margin:12px 0}
      .prose blockquote{border-left:3px solid #ddd;margin:16px 0;padding:8px 14px;color:#333;background:#fafafa}
      .prose code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#f6f6f6;padding:2px 4px;border-radius:6px}
      pre{background:#0b1020;color:#e6edf3;border-radius:12px;padding:14px 16px;overflow:auto;position:relative}
      pre .copy{position:absolute;top:8px;right:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;cursor:pointer}
      img{max-width:100%;height:auto;border-radius:10px}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid var(--line);padding:8px 10px}
      hr{border:none;border-top:1px solid var(--line);margin:28px 0}

      .footer-tags{margin-top:22px; display:flex; gap:8px; flex-wrap:wrap}
      .footer-tags a{border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; color:#333; text-decoration:none}

      footer{border-top:1px solid var(--line);background:var(--bg-soft);color:#555}
      footer .inner{max-width:var(--max);margin:0 auto;padding:22px 20px;display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}
      footer a{text-decoration:none;color:#666}
    </style>
  </head>
  <body>
    <nav aria-label="Primary">
      <div class="inner">
        <div class="left">
          <a href="https://marlowgate.com/" class="brand">Marlow Gate</a>
          <a href="/blog/">Blog</a>
          <a href="/about">About</a>
        </div>
        <div class="right">
          <a href="/rss.xml">RSS</a>
          <a href="/sitemap.xml">Sitemap</a>
          <a href="https://marlowgate.com/store/">Store</a>
        </div>
      </div>
    </nav>

    <div class="wrap">
      {headings.length > 0 && (
        <aside class="toc" aria-label="Contents">
          <h2>Contents</h2>
          <ul>
            {headings.map((h) => (
              <li class={`lvl${h.depth}`}>
                <a href={`#${h.slug}`}>{h.text}</a>
              </li>
            ))}
          </ul>
        </aside>
      )}

      <article>
        <header>
          <h1 class="title">{title}</h1>
          <div class="meta">
            {frontmatter.pubDate && <time datetime={pubISO}>Published: {new Date(frontmatter.pubDate).toLocaleDateString('ja-JP')}</time>}
            {frontmatter.updatedDate && <time datetime={modISO}>Updated: {new Date(frontmatter.updatedDate).toLocaleDateString('ja-JP')}</time>}
            {tags.length > 0 && (
              <span class="tags">
                {tags.map((t: string) => <span class="tag"><a href={`/tags/${encodeURIComponent(t)}/`}>{t}</a></span>)}
              </span>
            )}
          </div>
        </header>

        <div class="prose">
          <slot />
        </div>

        {tags.length > 0 && (
          <div class="footer-tags" aria-label="Tags">
            {tags.map((t: string) => <a href={`/tags/${encodeURIComponent(t)}/`}>#{t}</a>)}
          </div>
        )}

        <CTA />
      </article>
    </div>

    <footer>
      <div class="inner">
        <div>© {new Date().getFullYear()} Marlow Gate</div>
        <div>
          <a href="/blog/">Blog</a> · <a href="/about">About</a> · <a href="/rss.xml">RSS</a> · <a href="/sitemap.xml">Sitemap</a> · <a href="https://marlowgate.com/">LP</a> · <a href="https://marlowgate.com/store/">Store</a>
        </div>
      </div>
    </footer>

    <script is:inline>
      (function(){
        document.querySelectorAll('pre > code').forEach((code) => {
          const pre = code.parentElement;
          if (!pre) return;
          const btn = document.createElement('button');
          btn.className = 'copy';
          btn.textContent = 'Copy';
          btn.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(code.textContent || '');
              btn.textContent = 'Copied!';
              setTimeout(() => btn.textContent = 'Copy', 1200);
            } catch {}
          });
          pre.appendChild(btn);
        });
      })();
    </script>

    <script type="application/ld+json" is:inline>
      {JSON.stringify({
        "@context":"https://schema.org",
        "@type":"Article",
        "headline": title,
        "description": description,
        "url": canonical,
        "image": og,
        "datePublished": pubISO,
        "dateModified": modISO,
        "author": {"@type":"Organization","name":"Marlow Gate"},
        "publisher": {"@type":"Organization","name":"Marlow Gate"}
      })}
    </script>
  </body>
</html>
