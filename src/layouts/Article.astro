---
import SiteNav from "../components/SiteNav.astro";
import SiteFooter from "../components/SiteFooter.astro";
import Toc from "../components/Toc.astro";
import CTA from "../components/CTA.astro";
import MetaArticle from "../components/MetaArticle.astro";

const fm = Astro.props || {};
const url = Astro.url?.href ?? "";
const title = fm.title ?? "Untitled";
const description = fm.description ?? "";
const datePublished = fm.pubDate ?? fm.date ?? undefined;
const authorName = fm.author ?? "Marlow Gate";
---
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} — Marlow Gate</title>
    <meta name="description" content={description} />
    <MetaArticle url={url} title={title} description={description} datePublished={datePublished} authorName={authorName} />
    <style>
      /* Layout: single column on mobile, sidebar TOC on desktop */
      .grid { max-width: 1080px; margin:0 auto; display:grid; grid-template-columns: 1fr; gap:28px; }
      @media (min-width: 960px) {
        .grid { grid-template-columns: 240px 1fr; align-items:start; }
        #toc-wrap { position: sticky; top: 16px; }
      }

      /* Typography & components */
      article { font-size:16px; }
      article h2 { margin:28px 0 10px; font-size:24px; line-height:1.35; }
      article h3 { margin:22px 0 8px; font-size:18px; line-height:1.4; }
      article p, article li { line-height:1.85; }
      article ul, article ol { padding-left:22px; }
      article blockquote { margin:16px 0; padding:10px 14px; border-left:3px solid #ddd; background:#fafafa; color:#333; }
      article table { border-collapse: collapse; width:100%; margin:16px 0; }
      article th, article td { border:1px solid #eee; padding:8px 10px; text-align:left; }
      article img { max-width:100%; height:auto; border-radius:10px; }

      /* Code blocks */
      pre { background:#0f172a; color:#e2e8f0; padding:14px 16px; border-radius:12px; overflow:auto; margin:16px 0; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.95em; }
      pre code { display:block; }
      :not(pre) > code { background: #f4f4f5; color:#111; padding:2px 6px; border-radius:6px; }

      /* Footnotes */
      sup[role="doc-noteref"] a { text-decoration:none; }
      .footnotes { font-size:13px; color:#444; }
      .footnotes hr { display:none; }
      .footnotes ol { padding-left:20px; }
      .footnotes li { margin-bottom:6px; }
      .footnotes a[role="doc-backlink"] { margin-left:8px; text-decoration:none; color:#666; }

      /* Heading anchor link (hover) */
      article h2:hover a.anchor, article h3:hover a.anchor { opacity:1; }
      a.anchor { opacity:0; margin-left:6px; text-decoration:none; color:#aaa; }
    </style>
  </head>
  <body style="font-family: ui-sans-serif, system-ui; margin:0; color:#111; line-height:1.65;">
    <SiteNav />
    <main style="padding:28px 20px;">
      <div class="grid">
        <div id="toc-wrap">
          <Toc />
        </div>
        <article>
          <h1 style="margin:0 0 12px 0; font-size:30px; line-height:1.25;">{title}</h1>
          {description && <p style="color:#555; margin-top:0;">{description}</p>}
          <slot />
          <CTA />
        </article>
      </div>
    </main>
    <SiteFooter />
    <script>
      // Add anchor links to headings (h2/h3)
      const article = document.querySelector('article');
      if (article) {
        const headings = article.querySelectorAll('h2, h3');
        headings.forEach(h => {
          if (!h.id) { h.id = h.textContent.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
          const a = document.createElement('a');
          a.href = `#${h.id}`;
          a.className = 'anchor';
          a.textContent = '¶';
          h.appendChild(a);
        });
      }
      // Copy button for code blocks
      document.querySelectorAll('pre > code').forEach((code) => {
        const pre = code.parentElement;
        const btn = document.createElement('button');
        btn.textContent = 'Copy';
        btn.style.cssText = 'position:absolute; right:10px; top:8px; padding:4px 8px; border:1px solid #334155; background:#1e293b; color:#e2e8f0; border-radius:6px; cursor:pointer;';
        const wrap = document.createElement('div');
        wrap.style.position = 'relative';
        pre.parentNode.insertBefore(wrap, pre);
        wrap.appendChild(pre);
        wrap.appendChild(btn);
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(code.textContent);
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = 'Copy', 1200);
        });
      });
    </script>
  </body>
</html>
