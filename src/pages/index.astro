---
import SiteNav from "../components/SiteNav.astro";
import SiteFooter from "../components/SiteFooter.astro";

const g1 = import.meta.glob("./blog/**/*.{md,mdx}", { eager: true });
const g2 = import.meta.glob("../content/blog/**/*.{md,mdx}", { eager: true });

function entries(obj) { return Object.entries(obj || {}); }
function slugFromFile(file) { const m = file.match(/(?:^|\/)blog\/(.+?)\.(mdx?|MDX?|md|MD)$/); return m ? m[1] : null; }

function toEntry([file, mod]) {
  const fm = mod.frontmatter || mod.data || {};
  const slug = slugFromFile(file);
  const href = slug ? `/blog/${slug}/` : (typeof mod.url === "string" && /^\/blog\//.test(mod.url) ? mod.url : "/");
  return { key: href, href, title: fm.title || "Untitled", description: fm.description || fm.summary || "", date: fm.pubDate || fm.date || null, draft: fm.draft === true };
}

const map = new Map();
[...entries(g1), ...entries(g2)].map(toEntry).forEach((p) => { if (!p.draft && p.href && p.href !== "/") { const prev = map.get(p.key); const da = p.date ? new Date(p.date).getTime() : 0; const db = prev?.date ? new Date(prev.date).getTime() : 0; if (!prev || da >= db) map.set(p.key,p); } });
const posts = Array.from(map.values()).sort((a,b)=>{const da=a.date?new Date(a.date).getTime():0; const db=b.date?new Date(b.date).getTime():0; return db-da;}).slice(0,3);
---
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Marlow Gate — Blog</title>
    <meta name="description" content="Latest articles and updates from Marlow Gate" />
    <link rel="canonical" href={Astro.url?.href} />
  </head>
  <body style="font-family: ui-sans-serif, system-ui; margin:0; color:#111; line-height:1.65;">
    <SiteNav />
    <section style="padding:48px 20px; background:#fafafa; border-bottom:1px solid #eee;">
      <div style="max-width:900px; margin:0 auto;">
        <h1 style="margin:0 0 12px 0; font-size:28px; line-height:1.25;">Trading data &amp; automation — insights and releases</h1>
        <p style="margin:0 0 18px 0; color:#555;">Latest articles and updates from Marlow Gate</p>
        <a href="/store/" style="display:inline-block; padding:10px 16px; border-radius:10px; border:1px solid #111; text-decoration:none; color:#111;">Go to Store</a>
      </div>
    </section>
    <section style="padding:28px 20px;">
      <div style="max-width:900px; margin:0 auto; display:grid; grid-template-columns:1fr; gap:16px;">
        {posts.length === 0 ? (
          <div style="color:#666;">No posts yet. Add <code>*.md</code> or <code>*.mdx</code> under <code>src/pages/blog/</code> or <code>src/content/blog/</code>.</div>
        ) : (
          posts.map((p) => (
            <a href={p.href} style="display:block; padding:16px; border:1px solid #eee; border-radius:12px; text-decoration:none; color:#111;">
              <div style="font-weight:600; margin-bottom:6px;">{p.title}</div>
              {p.description && <div style="color:#555; font-size:14px; margin-bottom:8px;">{p.description}</div>}
              {p.date && <div style="color:#888; font-size:12px;">{new Date(p.date).toISOString().slice(0,10)}</div>}
            </a>
          ))
        )}
      </div>
    </section>
    <SiteFooter />
  </body>
</html>
