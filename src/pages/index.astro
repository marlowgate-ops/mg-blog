---
import Hero from "../components/Hero.astro";
import PostCard from "../components/PostCard.astro";

// Use Vite's import.meta.glob which returns an empty object when no matches.
// This avoids AstroGlobNoMatch errors on empty directories.
const g1 = import.meta.glob("./blog/*.{md,mdx}", { eager: true });
const g2 = import.meta.glob("./blog/**/*.{md,mdx}", { eager: true });
const g3 = import.meta.glob("../content/blog/*.{md,mdx}", { eager: true });
const g4 = import.meta.glob("../content/blog/**/*.{md,mdx}", { eager: true });

function values(obj) {
  return Object.keys(obj).map((k) => obj[k]);
}

const groups = [
  ...values(g1),
  ...values(g2),
  ...values(g3),
  ...values(g4),
];

const posts = groups
  .map((mod) => ({
    href: mod.url || (mod.frontmatter && mod.frontmatter.url) || "#",
    title: (mod.frontmatter && mod.frontmatter.title) || "Untitled",
    description: (mod.frontmatter && (mod.frontmatter.description || mod.frontmatter.summary)) || "",
    date: (mod.frontmatter && (mod.frontmatter.pubDate || mod.frontmatter.date)) || null,
    raw: mod,
  }))
  .filter((p) => p.href && p.href !== "#" && !(p.raw.frontmatter && p.raw.frontmatter.draft === true))
  .sort((a, b) => {
    const da = a.date ? new Date(a.date).getTime() : 0;
    const db = b.date ? new Date(b.date).getTime() : 0;
    return db - da;
  })
  .slice(0, 3);
---

<Hero title="Trading data & automation â€” insights and releases" subtitle="Latest articles and updates from Marlow Gate" ctaHref="/store/" ctaLabel="Go to Store" />

<section style="padding:28px 20px;">
  <div style="max-width:900px; margin:0 auto; display:grid; grid-template-columns:1fr; gap:16px;">
    {posts.length === 0 ? (
      <div style="color:#666;">No posts yet. Add <code>*.md</code> or <code>*.mdx</code> under <code>src/pages/blog/</code> or <code>src/content/blog/</code>.</div>
    ) : (
      posts.map((p) => <PostCard post={p.raw} />)
    )}
  </div>
</section>
